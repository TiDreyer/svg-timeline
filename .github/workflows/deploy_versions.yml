name: Deploy tagged versions to PyPI

on:
  push:
    tags:
      - '[0-9]+\.[0-9]+\.[0-9]+'  # matches semantic version tags like 1.2.3

jobs:
  build-and-deploy:
    name: test_and_lint
    runs-on: ubuntu-latest
    environment: main branch
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Update Version Number
        run: |
          OLD_VERSION=$(grep ^version pyproject.toml | cut -d '"' -f 2)
          OLD_VERSION="\"$OLD_VERSION\""
          NEW_VERSION="\"$GITHUB_REF_NAME\""
          sed -i "s+version = $OLD_VERSION+version = $NEW_VERSION+g" pyproject.toml

      - name: Commit Changes
        run: |
          git config user.name "$GITHUB_ACTOR"
          git config user.email "$GITHUB_ACTOR@users.noreply.github.com"
          git commit -a -m "Update version number to new_version"
          git push origin HEAD:main

      - name: Install uv
        uses: astral-sh/setup-uv@v6

      - name: Build package
        run: uv build

      - name: Publish package
        run: uv publish --token ${{ secrets.PYPI_TOKEN }}
